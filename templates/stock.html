<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>FLOWORK</title>
    <link rel="icon" href="{{ url_for('static', filename='symbol.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/journal/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body data-analyze-excel-url="{{ url_for('api.analyze_excel') }}">
    <div class="container my-4">
        {% include '_header.html' %}
        {% include '_navigation.html' %}
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert {{ 'alert-success' if category == 'success' else 'alert-danger' }} alert-dismissible fade show">
                    {{ message }} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <hr> 
        <div class="mb-4">
             <h2 class="section-title"><i class="bi bi-database-gear me-2"></i>재고 데이터 관리</h2>
             
             <div class="card mb-3 management-section">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-house-gear me-2"></i>매장재고 UPSERT (추가/수정)</h3>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>(STOCK_ST) 매장재고를 업데이트 (추가/수정) 합니다.</strong>
                        <span>(1) '파일 선택' -> (2) 열 분석 -> (3) 열 매핑 -> (4) '검토 및 업데이트' 클릭<br>
                        (DB에 없는 상품/옵션은 자동으로 생성되며, 기존 상품은 가격/재고가 수정됩니다.)</span>
                    </div>
                    
                    <form action="{{ url_for('api.update_store_stock_excel') }}" method="POST" enctype="multipart/form-data" 
                          class="update-stock-form" id="form-update-store"
                          onsubmit="return confirm('엑셀 파일 검증을 시작합니다.\n검증 후 문제가 없는 행만 업로드됩니다.\n계속하시겠습니까?');">
                        
                        {% if not current_user.store_id %}
                        <div class="mb-3 p-3 bg-light border rounded">
                            <label for="target_store_id_main" class="form-label fw-bold text-primary">
                                <i class="bi bi-shop me-1"></i>업데이트 대상 매장 선택 (본사 관리자)
                            </label>
                            <select class="form-select" id="target_store_id_main" name="target_store_id" required>
                                <option value="">-- 재고를 넣을 매장을 선택하세요 --</option>
                                {% for store in all_stores %}
                                <option value="{{ store.id }}">{{ store.store_name }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text text-muted">* 선택한 매장의 재고로 반영됩니다.</div>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="store_stock_excel_file" class="form-label file-upload-wrapper" id="wrapper-store-file">
                                <i class="bi bi-file-earmark-excel-fill fs-4"></i>
                                <div>파일 선택 (매장재고)</div>
                                <div class="file-status-text" id="status-store-file">엑셀 파일을 선택하세요.</div>
                            </label>
                            <input type="file" name="excel_file" class="form-control" accept=".xlsx, .xls" required id="store_stock_excel_file">
                        </div>
                        
                        <div class="column-mapping-grid mb-3" id="grid-update-store" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_pn_store">품번*</label>
                                    <select id="col_pn_store" name="col_pn" class="form-select form-select-sm" required disabled>
                                        <option value="">-- 열 선택 --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_pn_store"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_pname_store">품명*</label>
                                    <select id="col_pname_store" name="col_pname" class="form-select form-select-sm" required disabled>
                                        <option value="">-- 열 선택 --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_pname_store"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_color_store">컬러*</label>
                                    <select id="col_color_store" name="col_color" class="form-select form-select-sm" required disabled>
                                        <option value="">-- 열 선택 --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_color_store"></div>
                                </div>
                            </div>
                            
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_size_store">사이즈 (자동)</label>
                                    <select id="col_size_store" name="col_size" class="form-select form-select-sm" disabled>
                                        <option value="">-- 자동 인식 --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_size_store"></div>
                                </div>
                            </div>

                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_oprice_store">최초가*</label>
                                    <select id="col_oprice_store" name="col_oprice" class="form-select form-select-sm" required disabled>
                                        <option value="">-- 열 선택 --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_oprice_store"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_sprice_store">판매가*</label>
                                    <select id="col_sprice_store" name="col_sprice" class="form-select form-select-sm" required disabled>
                                        <option value="">-- 열 선택 --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_sprice_store"></div>
                                </div>
                            </div>

                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_stock_store">매장재고 (자동)</label>
                                    <select id="col_stock_store" name="col_store_stock" class="form-select form-select-sm" disabled>
                                        <option value="">-- 자동 인식 --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_stock_store"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="progress-wrapper mb-3" style="display:none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <div class="progress-status text-center mt-1 text-muted small">처리 중...</div>
                        </div>

                        <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-clockwise me-1"></i>검토 및 업데이트</button>
                    </form>
                </div>
            </div>
            
            {% if not current_user.store_id %}
            <div class="card mb-3 management-section">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-database-fill-down me-2"></i>상품 데이터 전체 업로드 (DB 초기화)</h3>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>(요청) 엑셀 파일로 상품 데이터(STOCK_INFO)를 재설정합니다.</strong>
                        <span>(경고) 현재 브랜드의 기존 상품/옵션/재고 DB가 **모두 삭제**되고 엑셀 내용으로 덮어씁니다.</span>
                    </div>
                    <form action="{{ url_for('api.import_excel') }}" method="POST" enctype="multipart/form-data" 
                          class="update-stock-form" id="form-import-db"
                          onsubmit="return confirm('🚨 경고! DB를 덮어씁니다.\n계속하시겠습니까?');">
                        
                        <div class="mb-3">
                            <label for="db_excel_file" class="form-label file-upload-wrapper" id="wrapper-db-file">
                                <i class="bi bi-file-earmark-excel-fill fs-4"></i>
                                <div>파일 선택 (상품 DB)</div>
                                <div class="file-status-text" id="status-db-file">엑셀 파일을 선택하세요.</div>
                            </label>
                            <input type="file" name="excel_file" class="form-control" accept=".xlsx, .xls" required id="db_excel_file">
                        </div>

                        <div class="column-mapping-grid mb-3" id="grid-import-db">
                            <div class="mapping-item-wrapper"><div class="mapping-item">
                                <label for="col_pn_db">품번*</label>
                                <select id="col_pn_db" name="col_pn" class="form-select form-select-sm" required disabled><option value="">-- 열 --</option></select>
                                <div class="col-preview" id="preview_col_pn_db"></div>
                            </div></div>
                            <div class="mapping-item-wrapper"><div class="mapping-item">
                                <label for="col_pname_db">품명*</label>
                                <select id="col_pname_db" name="col_pname" class="form-select form-select-sm" required disabled><option value="">-- 열 --</option></select>
                                <div class="col-preview" id="preview_col_pname_db"></div>
                            </div></div>
                            <div class="mapping-item-wrapper"><div class="mapping-item">
                                <label for="col_year_db">출시년도</label>
                                <select id="col_year_db" name="col_year" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select>
                                <div class="col-preview" id="preview_col_year_db"></div>
                            </div></div>
                            <div class="mapping-item-wrapper"><div class="mapping-item">
                                <label for="col_category_db">품목</label>
                                <select id="col_category_db" name="col_category" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select>
                                <div class="col-preview" id="preview_col_category_db"></div>
                            </div></div>
                            <div class="mapping-item-wrapper"><div class="mapping-item">
                                <label for="col_color_db">컬러*</label>
                                <select id="col_color_db" name="col_color" class="form-select form-select-sm" required disabled><option value="">-- 열 --</option></select>
                                <div class="col-preview" id="preview_col_color_db"></div>
                            </div></div>
                            
                            <div class="mapping-item-wrapper"><div class="mapping-item">
                                <label for="col_size_db">사이즈 (자동)</label>
                                <select id="col_size_db" name="col_size" class="form-select form-select-sm" disabled>
                                    <option value="">-- 자동 인식 --</option>
                                </select>
                                <div class="col-preview" id="preview_col_size_db"></div>
                            </div></div>
                            
                            <div class="mapping-item-wrapper"><div class="mapping-item">
                                <label for="col_oprice_db">최초가</label>
                                <select id="col_oprice_db" name="col_oprice" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select>
                                <div class="col-preview" id="preview_col_oprice_db"></div>
                            </div></div>
                            <div class="mapping-item-wrapper"><div class="mapping-item">
                                <label for="col_sprice_db">판매가</label>
                                <select id="col_sprice_db" name="col_sprice" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select>
                                <div class="col-preview" id="preview_col_sprice_db"></div>
                            </div></div>
                            <div class="mapping-item-wrapper"><div class="mapping-item">
                                <label for="col_favorite_db">즐겨찾기</label>
                                <select id="col_favorite_db" name="col_favorite" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select>
                                <div class="col-preview" id="preview_col_favorite_db"></div>
                            </div></div>
                            
                            <div class="mapping-item-wrapper"><div class="mapping-item">
                                <label for="col_hq_stock_db">본사재고 (자동)</label>
                                <select id="col_hq_stock_db" name="col_hq_stock" class="form-select form-select-sm" disabled>
                                    <option value="">-- 자동 인식 --</option>
                                </select>
                                <div class="col-preview" id="preview_col_hq_stock_db"></div>
                            </div></div>
                        </div>

                        <div class="progress-wrapper mb-3" style="display:none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <div class="progress-status text-center mt-1 text-muted small">처리 중...</div>
                        </div>

                        <button type="submit" class="btn btn-danger"><i class="bi bi-upload me-1"></i>상품 DB 전체 업로드</button>
                    </form>
                </div>
            </div>
            {% endif %}
            
            {% if not current_user.store_id %}
            <div class="card mb-3 management-section">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-house-gear me-2"></i>매장재고 엑셀 업로드 (본사 전용)</h3>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>엑셀 파일로 '선택한 매장'의 재고(StoreStock.quantity)만 업데이트합니다. (바코드 2필드 기준)</strong>
                        <span>(1) '업데이트 대상 매장' 선택 -> (2) '파일 선택' -> (3) 열 분석 -> (4) '매장재고 업데이트' 클릭</span>
                    </div>
                    
                    <form action="{{ url_for('api.update_store_stock_excel') }}" method="POST" enctype="multipart/form-data" 
                          class="update-stock-form" id="form-update-store-hq"
                          onsubmit="return confirm('엑셀 파일 기준으로 선택한 매장의 재고를 (재고만) 수정합니다.\n(바코드 2필드 기준 / 신규 상품 추가 안함)\n계속하시겠습니까?');">
                        
                        <div class="mb-3">
                            <label for="target_store_id" class="form-label fw-bold">업데이트 대상 매장*</label>
                            <select class="form-select" id="target_store_id" name="target_store_id" required>
                                <option value="">-- 재고를 적용할 매장을 선택하세요 --</option>
                                {% for store in all_stores %}
                                <option value="{{ store.id }}">{{ store.store_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <hr>
                        <div class="mb-3">
                             <label for="store_stock_excel_file_hq" class="form-label file-upload-wrapper" id="wrapper-store-file-hq">
                                <i class="bi bi-file-earmark-excel-fill fs-4"></i>
                                <div>파일 선택 (매장재고 - 바코드)</div>
                                <div class="file-status-text" id="status-store-file-hq">엑셀 파일을 선택하세요.</div>
                            </label>
                            <input type="file" name="excel_file" class="form-control" accept=".xlsx, .xls" required id="store_stock_excel_file_hq">
                        </div>

                        <div class="column-mapping-grid mb-3" id="grid-update-store-hq">
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_barcode_store_hq">바코드*</label>
                                    <select id="col_barcode_store_hq" name="barcode_col" class="form-select form-select-sm" required disabled>
                                        <option value="">-- 열 선택 --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_barcode_store_hq"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_stock_store_hq">매장재고*</label>
                                    <select id="col_stock_store_hq" name="qty_col" class="form-select form-select-sm" required disabled>
                                        <option value="">-- 열 선택 --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_stock_store_hq"></div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-clockwise me-1"></i>매장재고 수정 (바코드)</button>
                    </form>
                </div>
            </div>
            {% endif %}
            
            {% if not current_user.store_id %}
            <div class="card mb-3 management-section border-danger">
                 <div class="card-header bg-danger text-white">
                     <h3 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>상품 데이터 초기화 (현재 브랜드)</h3>
                </div>
                <div class="card-body">
                    <div class="card-description text-danger">
                        <strong>(요청) 현재 브랜드의 '상품/옵션/재고' 데이터만 삭제합니다.</strong>
                        <span>(경고) '주문/공지/설정/계정'은 유지되지만, 현재 브랜드의 모든 '상품(Product)', '옵션(Variant)', '매장재고(StoreStock)' 기록이 영구적으로 삭제됩니다.</span>
                    </div>
                    <form action="{{ url_for('api.reset_database_completely') }}" method="POST" onsubmit="return confirm('🚨🚨🚨 최종 경고! 🚨🚨🚨\n\n데이터베이스의 모든 상품, 옵션, 재고 정보가 영구적으로 삭제됩니다.\n\n정말로 계속 진행하시겠습니까?');">
                        <button type="submit" class="btn btn-danger"><i class="bi bi-trash3-fill me-1"></i>상품 데이터 초기화</button>
                    </form>
                </div>
            </div>
            {% endif %}

        </div>

        <div class="modal fade" id="verification-modal" tabindex="-1" aria-labelledby="verificationModalLabel" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title" id="verificationModalLabel">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>데이터 검증: 의심 행 발견
                        </h5>
                        </div>
                    <div class="modal-body">
                        <div class="alert alert-secondary">
                            <strong><span id="suspicious-count">0</span>개의 행</strong>이 일반적인 데이터 형식이 아니거나(헤더/푸터 등), 필수 값이 누락되었습니다.<br>
                            제외할 행은 우측의 <span class="badge bg-danger">X</span> 버튼을 눌러 삭제하세요.<br>
                            <small class="text-muted">(삭제하지 않은 행은 그대로 업로드 시도됩니다.)</small>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover" style="font-size: 0.85rem;">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 60px;">행 번호</th>
                                        <th>데이터 미리보기</th>
                                        <th>의심 사유</th>
                                        <th style="width: 50px;" class="text-center">제외</th>
                                    </tr>
                                </thead>
                                <tbody id="suspicious-rows-tbody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="btn-cancel-verification" data-bs-dismiss="modal">취소</button>
                        <button type="button" class="btn btn-primary" id="btn-confirm-upload">
                            <i class="bi bi-upload me-1"></i> 검토 완료 및 업로드
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/stock.js') }}" defer></script>
</body>
</html>