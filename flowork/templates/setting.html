{% extends 'base.html' %}

{% block body_attrs %}
data-api-stores-url="{{ url_for('api.get_stores') }}"
data-api-stores-add-url="{{ url_for('api.add_store') }}"
data-api-store-update-url-prefix="{{ url_for('api.update_store', store_id=0)[:-1] }}"
data-api-store-delete-url-prefix="{{ url_for('api.delete_store', store_id=0)[:-1] }}"
data-api-brand-name-set-url="{{ url_for('api.update_brand_name') }}"
data-api-load-settings-url="{{ url_for('api.load_settings_from_file') }}"
data-api-setting-url="{{ url_for('api.update_setting') }}"
data-api-staff-add-url="{{ url_for('api.add_staff') }}"
data-api-staff-update-url-prefix="{{ url_for('api.update_staff', staff_id=0)[:-1] }}"
data-api-staff-delete-url-prefix="{{ url_for('api.delete_staff', staff_id=0)[:-1] }}"
data-api-store-approve-url-prefix="{{ url_for('api.approve_store', store_id=0)[:-1] }}"
data-api-store-toggle-active-url-prefix="{{ url_for('api.toggle_store_active', store_id=0)[:-1] }}"
data-api-store-reset-url-prefix="{{ url_for('api.reset_store_registration', store_id=0)[:-1] }}"
data-analyze-excel-url="{{ url_for('api.analyze_excel') }}"
{% endblock %}

{% block content %}
<div class="container my-4">
    
    {% if current_user.is_super_admin and brands %}
    <div class="card mb-4 shadow-sm border-primary">
        <div class="card-body py-2 d-flex align-items-center bg-light">
            <label class="fw-bold text-primary me-3 mb-0"><i class="bi bi-shield-lock-fill me-1"></i>ì„¤ì • ëŒ€ìƒ ë¸Œëœë“œ ì„ íƒ (Super Admin)</label>
            <form method="GET" action="{{ url_for('ui.setting_page') }}" class="d-flex">
                <select name="brand_id" class="form-select form-select-sm me-2" onchange="this.form.submit()" style="width: 200px;">
                    {% for brand in brands %}
                    <option value="{{ brand.id }}" {{ 'selected' if brand.id == target_brand_id else '' }}>
                        {{ brand.brand_name }}
                    </option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="mb-4">
        <h2 class="section-title"><i class="bi bi-gear-fill me-2"></i>ì„¤ì •</h2>
    </div>
    
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-tag-fill me-2"></i>ë¸Œëœë“œ ì„¤ì •</h5>
                </div>
                <div class="card-body">
                    <form id="form-brand-name" class="mb-4">
                        <label for="brand-name-input" class="form-label fw-bold">ë¸Œëœë“œ ì´ë¦„</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="brand-name-input" value="{{ brand_name }}" required>
                            <button class="btn btn-outline-primary" type="submit">ì €ì¥</button>
                        </div>
                        <div id="brand-name-status"></div>
                    </form>

                    <hr>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">ì„¤ì • íŒŒì¼ ë¡œë“œ</label>
                        <p class="text-muted small mb-2">
                            ì„œë²„ì˜ <code>brands/{{ expected_settings_file or 'ë¸Œëœë“œëª….json' }}</code> íŒŒì¼ì—ì„œ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
                            {% if loaded_settings_file %}
                            <br><span class="text-success"><i class="bi bi-check-circle-fill"></i> í˜„ì¬ ë¡œë“œë¨: {{ loaded_settings_file }}</span>
                            {% endif %}
                        </p>
                        <button class="btn btn-warning w-100" id="btn-load-settings">
                            <i class="bi bi-arrow-clockwise me-1"></i> ì„¤ì • íŒŒì¼ ë‹¤ì‹œ ë¡œë“œ
                        </button>
                        <div id="load-settings-status"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-grid-fill me-2"></i>ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì„¤ì •</h5>
                </div>
                <div class="card-body">
                    <form id="form-category-config">
                        <div class="mb-3">
                            <label class="form-label fw-bold">í•œ ì¤„ë‹¹ ë²„íŠ¼ ê°œìˆ˜</label>
                            <select class="form-select" id="cat-columns">
                                <option value="4">4ê°œ</option>
                                <option value="5">5ê°œ</option>
                                <option value="6">6ê°œ</option>
                            </select>
                        </div>
                        <label class="form-label fw-bold">ë²„íŠ¼ ëª©ë¡ (ë¼ë²¨ / ê°’)</label>
                        <div id="cat-buttons-container" class="mb-2" style="max-height: 300px; overflow-y: auto;"></div>
                        <button type="button" class="btn btn-sm btn-outline-secondary w-100 mb-3" id="btn-add-cat-row">
                            <i class="bi bi-plus-lg"></i> ë²„íŠ¼ ì¶”ê°€
                        </button>
                        <button type="submit" class="btn btn-info w-100 text-white">ì„¤ì • ì €ì¥</button>
                        <div id="category-config-status"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-5">

    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="bi bi-shop me-2"></i>ë§¤ì¥ ê´€ë¦¬</h4>
            </div>
            
            <div class="card mb-4 shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">ë§¤ì¥ ëª©ë¡</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 text-center" id="all-stores-table">
                            <thead class="table-light">
                                <tr>
                                    <th>ì½”ë“œ</th>
                                    <th>ë§¤ì¥ëª…</th>
                                    <th>ì—°ë½ì²˜</th>
                                    <th>ë‹´ë‹¹ì</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ìŠ¹ì¸</th>
                                    <th>í™œì„±</th>
                                    <th>ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for store in all_stores %}
                                <tr>
                                    <td>{{ store.store_code or '-' }}</td>
                                    <td class="fw-bold">{{ store.store_name }}</td>
                                    <td>{{ store.phone_number or '-' }}</td>
                                    <td>{{ store.manager_name or '-' }}</td>
                                    <td>
                                        {% if store.is_registered %}
                                            <span class="badge bg-success">ê°€ì…ë¨</span>
                                        {% else %}
                                            <span class="badge bg-secondary">ë¯¸ê°€ì…</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if store.is_approved %}
                                            <span class="text-success"><i class="bi bi-check-circle-fill"></i></span>
                                        {% else %}
                                            {% if store.is_registered %}
                                                <button class="btn btn-sm btn-primary btn-approve-store" data-id="{{ store.id }}">ìŠ¹ì¸</button>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-toggle-active-store {{ 'btn-outline-success' if store.is_active else 'btn-outline-secondary' }}" data-id="{{ store.id }}">
                                            {{ 'ON' if store.is_active else 'OFF' }}
                                        </button>
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary btn-edit-store" 
                                                    data-id="{{ store.id }}" 
                                                    data-code="{{ store.store_code or '' }}" 
                                                    data-name="{{ store.store_name }}" 
                                                    data-phone="{{ store.phone_number or '' }}">
                                                ìˆ˜ì •
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning btn-reset-store" data-id="{{ store.id }}" title="ë“±ë¡ ì´ˆê¸°í™”">
                                                ì´ˆê¸°í™”
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger btn-delete-store" data-id="{{ store.id }}">
                                                ì‚­ì œ
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-5">
                <div class="card-header">
                    <h5 class="mb-0">ë§¤ì¥ ì¶”ê°€</h5>
                </div>
                <div class="card-body">
                    <form id="form-add-store" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">ë§¤ì¥ ì½”ë“œ</label>
                            <input type="text" class="form-control" id="new_store_code" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ë§¤ì¥ ì´ë¦„</label>
                            <input type="text" class="form-control" id="new_store_name" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ì—°ë½ì²˜</label>
                            <input type="tel" class="form-control" id="new_store_phone">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-success w-100">ì¶”ê°€</button>
                        </div>
                        <div id="add-store-status" class="col-12"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-5">

    {% if current_user.store_id %}
    <div class="row">
        <div class="col-12">
            <h4 class="mb-3"><i class="bi bi-people me-2"></i>ì§ì› ê´€ë¦¬</h4>
            
            <div class="card mb-4 shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">ì§ì› ëª©ë¡</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 text-center" id="all-staff-table">
                            <thead class="table-light">
                                <tr>
                                    <th>ì´ë¦„</th>
                                    <th>ì§ì±…</th>
                                    <th>ì—°ë½ì²˜</th>
                                    <th>ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for staff in staff_list %}
                                <tr>
                                    <td class="fw-bold">{{ staff.name }}</td>
                                    <td>{{ staff.position or '-' }}</td>
                                    <td>{{ staff.contact or '-' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary btn-edit-staff" 
                                                data-id="{{ staff.id }}"
                                                data-name="{{ staff.name }}"
                                                data-position="{{ staff.position or '' }}"
                                                data-contact="{{ staff.contact or '' }}">ìˆ˜ì •</button>
                                        <button class="btn btn-sm btn-outline-danger btn-delete-staff" data-id="{{ staff.id }}">ì‚­ì œ</button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="text-muted p-3">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">ì§ì› ë“±ë¡</h5>
                </div>
                <div class="card-body">
                    <form id="form-add-staff" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">ì´ë¦„</label>
                            <input type="text" class="form-control" id="new_staff_name" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ì§ì±…</label>
                            <input type="text" class="form-control" id="new_staff_position">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ì—°ë½ì²˜</label>
                            <input type="tel" class="form-control" id="new_staff_contact">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">ë“±ë¡</button>
                        </div>
                        <div id="add-staff-status" class="col-12"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <hr class="my-5">
    {% endif %}

    <div class="row">
        <div class="col-12">
            <h4 class="mb-3"><i class="bi bi-database-check me-2"></i>ë°ì´í„° ë°±ì—… ë° ë³µêµ¬</h4>
            
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">ì£¼ë¬¸ ë‚´ì—­ (Orders)</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">ë°±ì—… (Excel ë‹¤ìš´ë¡œë“œ)</label>
                                <div class="input-group">
                                    <select class="form-select" id="orders_target_store">
                                        <option value="">ì „ì²´ ë§¤ì¥</option>
                                        {% for store in all_stores %}
                                        <option value="{{ store.id }}">{{ store.store_name }}</option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-outline-dark" onclick="downloadOrdersExcel()">
                                        <i class="bi bi-download"></i> ë‹¤ìš´ë¡œë“œ
                                    </button>
                                </div>
                            </div>
                            <hr>
                            <div class="mb-3">
                                <label class="form-label fw-bold">ë³µêµ¬ (Excel ì—…ë¡œë“œ)</label>
                                <form action="{{ url_for('api.import_orders_excel') }}" method="POST" enctype="multipart/form-data" onsubmit="return confirm('ì£¼ë¬¸ ë‚´ì—­ì„ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" class="target-store-id-input">
                                    <div class="input-group">
                                        <input type="file" name="excel_file" class="form-control" accept=".xlsx" required>
                                        <button type="submit" class="btn btn-danger">ë³µêµ¬</button>
                                    </div>
                                </form>
                            </div>
                            <hr>
                            <div class="d-grid">
                                <form action="{{ url_for('api.reset_orders_db') }}" method="POST" onsubmit="return confirm('ğŸš¨ ê²½ê³ : ì„ íƒí•œ ë§¤ì¥ì˜ ëª¨ë“  ì£¼ë¬¸ ë‚´ì—­ì´ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.\nì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="target_store_id" class="target-store-id-input">
                                    <button type="submit" class="btn btn-outline-danger w-100">
                                        <i class="bi bi-trash3-fill"></i> ì£¼ë¬¸ ë°ì´í„° ì´ˆê¸°í™”
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">ì¬ê³  ì‹¤ì‚¬ (Actual Stock)</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">ë°±ì—… (Excel ë‹¤ìš´ë¡œë“œ)</label>
                                <div class="input-group">
                                    <select class="form-select" id="stock_target_store">
                                        <option value="">ë§¤ì¥ ì„ íƒ (í•„ìˆ˜)</option>
                                        {% for store in all_stores %}
                                        <option value="{{ store.id }}">{{ store.store_name }}</option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-outline-success" onclick="downloadStockExcel()">
                                        <i class="bi bi-download"></i> ë‹¤ìš´ë¡œë“œ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if current_user.is_super_admin %}
                <div class="col-12">
                    <div class="card border-danger mt-4">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>ì‹œìŠ¤í…œ ì´ˆê¸°í™” (ìœ„í—˜ êµ¬ì—­)</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-danger fw-bold">
                                â€» ì£¼ì˜: ì•„ë˜ ê¸°ëŠ¥ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ ì‚¬ìš©í•˜ì„¸ìš”.
                            </p>
                            <div class="d-flex gap-2">
                                <form action="{{ url_for('api.reset_store_db') }}" method="POST" onsubmit="return confirm('ğŸš¨ ì •ë§ë¡œ ëª¨ë“  ë§¤ì¥, ê³„ì •, ì§ì›, ì„¤ì • ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ì ˆëŒ€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-danger">
                                        <i class="bi bi-trash-fill"></i> ì‹œìŠ¤í…œ ì „ì²´ ì´ˆê¸°í™” (ë§¤ì¥/ê³„ì •/ì„¤ì •)
                                    </button>
                                </form>
                                
                                <form action="{{ url_for('api.reset_database_completely') }}" method="POST" onsubmit="return confirm('ğŸš¨ ì •ë§ë¡œ ëª¨ë“  ìƒí’ˆ ë° ì¬ê³  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\níŒë§¤/ì£¼ë¬¸ ë‚´ì—­ì´ ìˆë‹¤ë©´ ë¨¼ì € ì‚­ì œí•´ì•¼ í•©ë‹ˆë‹¤.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-warning">
                                        <i class="bi bi-trash"></i> ìƒí’ˆ/ì¬ê³  DB ì´ˆê¸°í™”
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if current_user.is_admin and not current_user.store_id %}
<div class="modal fade" id="edit-store-modal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ë§¤ì¥ ìˆ˜ì •</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="form-edit-store"><div class="mb-3"><label>ì½”ë“œ</label><input type="text" class="form-control" id="edit_store_code" required></div><div class="mb-3"><label>ì´ë¦„</label><input type="text" class="form-control" id="edit_store_name" required></div><div class="mb-3"><label>ì—°ë½ì²˜</label><input type="tel" class="form-control" id="edit_store_phone"></div><div id="edit-store-status"></div></form></div><div class="modal-footer"><button class="btn btn-primary" id="btn-save-edit-store">ìˆ˜ì • ì™„ë£Œ</button></div></div></div></div>
{% endif %}

{% if current_user.is_admin and current_user.store_id %}
<div class="modal fade" id="edit-staff-modal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ì§ì› ìˆ˜ì •</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="form-edit-staff"><div class="mb-3"><label>ì´ë¦„</label><input type="text" class="form-control" id="edit_staff_name" required></div><div class="mb-3"><label>ì§ì±…</label><input type="text" class="form-control" id="edit_staff_position"></div><div class="mb-3"><label>ì—°ë½ì²˜</label><input type="tel" class="form-control" id="edit_staff_contact"></div><div id="edit-staff-status"></div></form></div><div class="modal-footer"><button class="btn btn-primary" id="btn-save-edit-staff">ìˆ˜ì • ì™„ë£Œ</button></div></div></div></div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/setting.js') }}" defer></script>
<script>
    window.initialCategoryConfig = {{ category_config | tojson | safe if category_config else 'null' }};
    
    function updateHiddenInputs(selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;
        const val = select.value;
        document.querySelectorAll('.target-store-id-input').forEach(input => {
                input.value = val;
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const ordersSelect = document.getElementById('orders_target_store');
        if (ordersSelect) {
            ordersSelect.addEventListener('change', () => updateHiddenInputs('orders_target_store'));
            updateHiddenInputs('orders_target_store');
        }
        
        const stockSelect = document.getElementById('stock_target_store');
        if (stockSelect) {
            stockSelect.addEventListener('change', () => updateHiddenInputs('stock_target_store'));
            updateHiddenInputs('stock_target_store'); 
        }
    });

    function downloadOrdersExcel() {
        let storeId = '';
        const select = document.getElementById('orders_target_store');
        if (select) {
                storeId = select.value;
        }
        window.location.href = "{{ url_for('api.export_orders_excel') }}?target_store_id=" + storeId;
    }
    
    function downloadStockExcel() {
        let storeId = '';
        const select = document.getElementById('stock_target_store');
        if (select) {
                storeId = select.value;
        }
        window.location.href = "{{ url_for('api.export_stock_check') }}?target_store_id=" + storeId;
    }
</script>
{% endblock %}