{% extends 'base.html' %}

{% block content %}
<div class="setting-container container my-4"
     data-api-stores-url="{{ url_for('api.get_stores') }}"
     data-api-stores-add-url="{{ url_for('api.add_store') }}"
     data-api-store-update-url-prefix="{{ url_for('api.update_store', store_id=0)[:-1] }}"
     data-api-store-delete-url-prefix="{{ url_for('api.delete_store', store_id=0)[:-1] }}"
     data-api-brand-name-set-url="{{ url_for('api.update_brand_name') }}"
     data-api-load-settings-url="{{ url_for('api.load_settings_from_file') }}"
     data-api-setting-url="{{ url_for('api.update_setting') }}"
     data-api-staff-add-url="{{ url_for('api.add_staff') }}"
     data-api-staff-update-url-prefix="{{ url_for('api.update_staff', staff_id=0)[:-1] }}"
     data-api-staff-delete-url-prefix="{{ url_for('api.delete_staff', staff_id=0)[:-1] }}"
     data-api-store-approve-url-prefix="{{ url_for('api.approve_store', store_id=0)[:-1] }}"
     data-api-store-toggle-active-url-prefix="{{ url_for('api.toggle_store_active', store_id=0)[:-1] }}"
     data-api-store-reset-url-prefix="{{ url_for('api.reset_store_registration', store_id=0)[:-1] }}"
     data-analyze-excel-url="{{ url_for('api.analyze_excel') }}">
    
    {% if current_user.is_super_admin and brands %}
    <div class="card mb-4 border-primary bg-light">
        <div class="card-body py-2 d-flex align-items-center">
            <span class="badge bg-primary me-2">Super Admin</span>
            <form method="GET" action="{{ url_for('ui.setting_page') }}" class="d-flex flex-grow-1 align-items-center">
                <label class="small fw-bold text-primary me-2 text-nowrap">설정 대상:</label>
                <select name="brand_id" class="form-select form-select-sm w-auto border-0 bg-transparent fw-bold text-primary" onchange="this.form.submit()">
                    {% for brand in brands %}
                    <option value="{{ brand.id }}" {{ 'selected' if brand.id == target_brand_id else '' }}>{{ brand.brand_name }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>
    {% endif %}

    <h4 class="fw-bold mb-4"><i class="bi bi-gear-fill me-2"></i>시스템 설정</h4>
    
    <div class="row g-4 mb-5">
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-white border-bottom-0 pb-0 pt-3">
                    <h6 class="fw-bold text-dark"><i class="bi bi-tag me-1"></i>브랜드 정보</h6>
                </div>
                <div class="card-body">
                    <form id="form-brand-name" class="mb-4">
                        <label class="form-label small text-muted">브랜드 표시 이름</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="brand-name-input" value="{{ brand_name }}" required>
                            <button class="btn btn-outline-dark" type="submit">변경</button>
                        </div>
                    </form>
                    <div class="p-3 bg-light rounded border border-light">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="small fw-bold text-secondary mb-0">설정 파일 동기화</label>
                            {% if loaded_settings_file %}
                            <span class="badge bg-success bg-opacity-10 text-success border border-success px-2">로드됨: {{ loaded_settings_file }}</span>
                            {% endif %}
                        </div>
                        <p class="text-muted small mb-2" style="font-size: 0.8rem;">
                            서버의 <code>brands/{{ expected_settings_file or '브랜드명.json' }}</code> 파일을 로드합니다.
                        </p>
                        <button class="btn btn-sm btn-white border w-100" id="btn-load-settings">
                            <i class="bi bi-arrow-repeat me-1"></i>설정 다시 불러오기
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-white border-bottom-0 pb-0 pt-3">
                    <h6 class="fw-bold text-dark"><i class="bi bi-grid me-1"></i>검색 버튼 설정</h6>
                </div>
                <div class="card-body">
                    <form id="form-category-config">
                        <div class="mb-2">
                            <label class="form-label small text-muted">가로 배치 개수</label>
                            <select class="form-select form-select-sm" id="cat-columns">
                                <option value="4">4개</option>
                                <option value="5">5개</option>
                                <option value="6">6개</option>
                            </select>
                        </div>
                        <label class="form-label small text-muted">버튼 목록 (표시명 / 실제값)</label>
                        <div id="cat-buttons-container" class="mb-2 custom-scrollbar" style="max-height: 200px; overflow-y: auto; border: 1px solid #f1f3f5; border-radius: 4px; padding: 5px;"></div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-light border flex-fill" id="btn-add-cat-row">
                                <i class="bi bi-plus-lg"></i> 추가
                            </button>
                            <button type="submit" class="btn btn-sm btn-primary flex-fill">저장</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-12">
            <h5 class="fw-bold mb-3"><i class="bi bi-shop-window me-2"></i>매장 및 조직 관리</h5>
            
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 text-center" id="all-stores-table" style="font-size: 0.9rem;">
                            <thead class="table-light">
                                <tr>
                                    <th>코드</th>
                                    <th>매장명</th>
                                    <th>연락처</th>
                                    <th>담당자</th>
                                    <th>상태</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for store in all_stores %}
                                <tr>
                                    <td class="text-muted">{{ store.store_code or '-' }}</td>
                                    <td class="fw-bold">{{ store.store_name }}</td>
                                    <td>{{ store.phone_number or '-' }}</td>
                                    <td>{{ store.manager_name or '-' }}</td>
                                    <td>
                                        {% if not store.is_registered %}
                                            <span class="badge bg-secondary">미가입</span>
                                        {% elif not store.is_approved %}
                                            <button class="btn btn-xs btn-primary btn-approve-store" data-id="{{ store.id }}">승인필요</button>
                                        {% else %}
                                            <button class="btn btn-xs btn-toggle-active-store {{ 'btn-outline-success' if store.is_active else 'btn-outline-secondary' }}" data-id="{{ store.id }}">
                                                {{ '활성' if store.is_active else '비활성' }}
                                            </button>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-light border-0" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                            <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                                                <li><a class="dropdown-item btn-edit-store" href="#" data-id="{{ store.id }}" data-code="{{ store.store_code or '' }}" data-name="{{ store.store_name }}" data-phone="{{ store.phone_number or '' }}"><i class="bi bi-pencil me-2"></i>수정</a></li>
                                                <li><a class="dropdown-item btn-reset-store text-warning" href="#" data-id="{{ store.id }}"><i class="bi bi-arrow-counterclockwise me-2"></i>가입 초기화</a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item btn-delete-store text-danger" href="#" data-id="{{ store.id }}"><i class="bi bi-trash me-2"></i>삭제</a></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white border-top-0 p-3">
                    <form id="form-add-store" class="row g-2 align-items-center">
                        <div class="col-auto"><span class="badge bg-light text-dark border">신규 매장</span></div>
                        <div class="col"><input type="text" class="form-control form-control-sm" id="new_store_code" placeholder="매장코드" required></div>
                        <div class="col"><input type="text" class="form-control form-control-sm" id="new_store_name" placeholder="매장명" required></div>
                        <div class="col"><input type="tel" class="form-control form-control-sm" id="new_store_phone" placeholder="연락처"></div>
                        <div class="col-auto"><button type="submit" class="btn btn-sm btn-dark px-3">추가</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% if current_user.store_id %}
    <div class="row mb-5">
        <div class="col-12">
            <h5 class="fw-bold mb-3"><i class="bi bi-people me-2"></i>직원 관리</h5>
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 text-center" id="all-staff-table" style="font-size: 0.9rem;">
                            <thead class="table-light"><tr><th>이름</th><th>직책</th><th>연락처</th><th>관리</th></tr></thead>
                            <tbody>
                                {% for staff in staff_list %}
                                <tr>
                                    <td class="fw-bold">{{ staff.name }}</td>
                                    <td>{{ staff.position or '-' }}</td>
                                    <td>{{ staff.contact or '-' }}</td>
                                    <td>
                                        <button class="btn btn-xs btn-outline-secondary btn-edit-staff me-1" data-id="{{ staff.id }}" data-name="{{ staff.name }}" data-position="{{ staff.position or '' }}" data-contact="{{ staff.contact or '' }}">수정</button>
                                        <button class="btn btn-xs btn-outline-danger btn-delete-staff" data-id="{{ staff.id }}">삭제</button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="text-muted small py-3">등록된 직원이 없습니다.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white border-top-0 p-3">
                    <form id="form-add-staff" class="row g-2 align-items-center">
                        <div class="col-auto"><span class="badge bg-light text-dark border">신규 직원</span></div>
                        <div class="col"><input type="text" class="form-control form-control-sm" id="new_staff_name" placeholder="이름" required></div>
                        <div class="col"><input type="text" class="form-control form-control-sm" id="new_staff_position" placeholder="직책"></div>
                        <div class="col"><input type="tel" class="form-control form-control-sm" id="new_staff_contact" placeholder="연락처"></div>
                        <div class="col-auto"><button type="submit" class="btn btn-sm btn-primary px-3">등록</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-12">
            <h5 class="fw-bold mb-3"><i class="bi bi-database me-2"></i>데이터 관리</h5>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-header bg-light border-0"><h6 class="mb-0 fw-bold">주문 내역 (Orders)</h6></div>
                        <div class="card-body">
                            <div class="d-flex gap-2 mb-3">
                                <select class="form-select form-select-sm" id="orders_target_store">
                                    <option value="">전체 매장</option>
                                    {% for store in all_stores %}
                                    <option value="{{ store.id }}">{{ store.store_name }}</option>
                                    {% endfor %}
                                </select>
                                <button class="btn btn-sm btn-outline-dark text-nowrap" onclick="downloadOrdersExcel()"><i class="bi bi-download me-1"></i>백업</button>
                            </div>
                            <form action="{{ url_for('api.import_orders_excel') }}" method="POST" enctype="multipart/form-data" class="d-flex gap-2" onsubmit="return confirm('주문 내역을 복구하시겠습니까?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="target_store_id" class="target-store-id-input">
                                <input type="file" name="excel_file" class="form-control form-control-sm" accept=".xlsx" required>
                                <button type="submit" class="btn btn-sm btn-danger text-nowrap">복구</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-header bg-light border-0"><h6 class="mb-0 fw-bold">재고 실사 (Stock)</h6></div>
                        <div class="card-body">
                            <div class="d-flex gap-2">
                                <select class="form-select form-select-sm" id="stock_target_store">
                                    <option value="">매장 선택 (필수)</option>
                                    {% for store in all_stores %}
                                    <option value="{{ store.id }}">{{ store.store_name }}</option>
                                    {% endfor %}
                                </select>
                                <button class="btn btn-sm btn-outline-success text-nowrap" onclick="downloadStockExcel()"><i class="bi bi-download me-1"></i>백업</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="edit-store-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header py-2"><h6 class="modal-title fw-bold">매장 정보 수정</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="form-edit-store"><div class="mb-2"><label class="small text-muted">코드</label><input type="text" class="form-control" id="edit_store_code" required></div><div class="mb-2"><label class="small text-muted">이름</label><input type="text" class="form-control" id="edit_store_name" required></div><div class="mb-2"><label class="small text-muted">연락처</label><input type="tel" class="form-control" id="edit_store_phone"></div></form></div><div class="modal-footer py-2"><button class="btn btn-primary btn-sm" id="btn-save-edit-store">저장</button></div></div></div></div>

<div class="modal fade" id="edit-staff-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header py-2"><h6 class="modal-title fw-bold">직원 정보 수정</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="form-edit-staff"><div class="mb-2"><label class="small text-muted">이름</label><input type="text" class="form-control" id="edit_staff_name" required></div><div class="mb-2"><label class="small text-muted">직책</label><input type="text" class="form-control" id="edit_staff_position"></div><div class="mb-2"><label class="small text-muted">연락처</label><input type="tel" class="form-control" id="edit_staff_contact"></div></form></div><div class="modal-footer py-2"><button class="btn btn-primary btn-sm" id="btn-save-edit-staff">저장</button></div></div></div></div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/setting.js') }}" defer></script>
<script>
    window.initialCategoryConfig = {{ category_config | tojson | safe if category_config else 'null' }};
    
    function updateHiddenInputs(selectId) {
        const container = document.querySelector('.setting-container');
        if (!container) return;
        const select = container.querySelector('#' + selectId);
        if (!select) return;
        const val = select.value;
        container.querySelectorAll('.target-store-id-input').forEach(input => { input.value = val; });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const container = document.querySelector('.setting-container');
        if (container) {
            const ordersSelect = container.querySelector('#orders_target_store');
            if (ordersSelect) {
                ordersSelect.addEventListener('change', () => updateHiddenInputs('orders_target_store'));
                updateHiddenInputs('orders_target_store');
            }
            const stockSelect = container.querySelector('#stock_target_store');
            if (stockSelect) {
                stockSelect.addEventListener('change', () => updateHiddenInputs('stock_target_store'));
                updateHiddenInputs('stock_target_store'); 
            }
        }
    });

    function downloadOrdersExcel() {
        const container = document.querySelector('.setting-container');
        let storeId = container ? container.querySelector('#orders_target_store')?.value : '';
        window.location.href = "{{ url_for('api.export_orders_excel') }}?target_store_id=" + storeId;
    }
    
    function downloadStockExcel() {
        const container = document.querySelector('.setting-container');
        let storeId = container ? container.querySelector('#stock_target_store')?.value : '';
        if(!storeId) return alert('매장을 선택해주세요.');
        window.location.href = "{{ url_for('api.export_stock_check') }}?target_store_id=" + storeId;
    }
</script>
{% endblock %}